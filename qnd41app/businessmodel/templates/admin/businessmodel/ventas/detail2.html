{% extends "admin/base_site.html" %}
{% load static %}



{% block extrastyle %}
<link rel="stylesheet" href="{% static 'admin/css/changelists.css' %}">
<link rel="stylesheet" href="{% static 'admin/css/forms.css' %}">
<style>
  /* CSS para hacer que la imagen sea responsive */
  .responsive-img {
    max-width: 100%;
    height: auto;
  }
  
  /* Estilos para las pestañas */
  .tabs {
    overflow: hidden;
    background-color: #f8f9fa;
    display: flex;
    flex-wrap: wrap;
  }

  .tab-button {
    background-color: #ddd;
    border: none;
    outline: none;
    padding: 14px 16px;
    cursor: pointer;
    flex: 1;
    text-align: center;
    transition: background-color 0.3s ease;
  }

  .tab-button:hover {
    background-color: #ccc;
  }

  .tab-content {
    display: none;
    padding: 20px;
    border: 1px solid #ddd;
    border-top: none;
  }

  .tab-content.active {
    display: block;
  }

  /* Estilos para pantallas pequeñas */
  @media screen and (max-width: 768px) {
    .tab-button {
      font-size: 14px;
      padding: 10px;
    }
  }

  /* Estilos para pantallas muy pequeñas */
  @media screen and (max-width: 480px) {
    .tab-button {
      font-size: 12px;
      padding: 8px;
    }
  }

  /* Estilo para la tabla de información de venta */
  .info-table {
    width: 100%;
    border-collapse: collapse;
  }

  .info-table th, .info-table td {
    padding: 8px;
    border: 1px solid #ddd;
  }

  .info-table th {
    background-color: #f4f4f4;
  }

  /* Anchos específicos para las columnas de información */
  .info-table .info-name {
    max-width: 150px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .info-table .info-value {
    max-width: 250px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* Estilos para la barra de notificaciones */
  .notifications-container {
    overflow: hidden;
    white-space: nowrap;
    position: relative;
    background-color: #d54433;
    border: 1px solid #ddd;
    color: #fff;
    padding: 10px;
    margin-bottom: 0px; /* Añadido para separación */
    width: 100%;
    box-sizing: border-box;
    font-weight: 700;
  }

  .notifications-content {
    display: inline-block;
    white-space: nowrap;
    animation: marquee 20s linear infinite;
    max-width: 100%;
  }

  /* Estilos para el formulario */
form {
    display: flex;
    flex-direction: column;
    gap: 15px; /* Espacio entre los campos del formulario y el botón */
}

/* Estilos para la fila de campos */
.form-row {
    display: flex;
    flex-wrap: wrap; /* Permite que los campos se envuelvan en múltiples líneas si no caben en una sola fila */
    gap: 15px; /* Espacio entre los campos */
}

/* Estilos para cada grupo de campo */
.form-group {
    flex: 1; /* Permite que cada grupo de campo se ajuste automáticamente */
    min-width: 150px; /* Establece un ancho mínimo para los campos */
    display: flex;
    flex-direction: column;
    gap: 5px; /* Espacio entre la etiqueta y el campo del formulario */
}

.form-group label {
    font-weight: bold;
}

.form-group input,
.form-group select,
.form-group textarea {
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 16px;
    width: 100%; /* Asegura que el campo ocupe todo el ancho disponible */
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    border-color: #d54433;
    outline: none;
}

button[type="submit"] {
    padding: 10px 20px;
    background-color: #d54433;
    border: none;
    border-radius: 5px;
    color: #fff;
    font-size: 16px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

button[type="submit"]:hover {
    background-color: #d54433;
}


  @keyframes marquee {
    0% { transform: translateX(100%); }
    100% { transform: translateX(-100%); }
  }

  /* Ajuste para pantallas pequeñas */
  @media screen and (max-width: 768px) {
    .notifications-container {
      font-size: 14px;
    }
  }

  @media screen and (max-width: 480px) {
    .notifications-container {
      font-size: 12px;
    }
  }

  /* Estilos generales */
.chart-wrapper {
    display: flex;
    flex-direction: column; /* Coloca los elementos en una columna */
    gap: 20px; /* Espacio entre los elementos */
}

.filter-form {
    width: 100%;
    max-width: 800px; /* Ajusta el tamaño máximo del formulario */
    margin: 0 auto; /* Centra el formulario en la página */
}

.chart-container {
    width: 100%;
    max-width: 800px; /* Ajusta el tamaño máximo del contenedor del gráfico */
    margin: 0 auto; /* Centra el gráfico en la página */
}

#chart {
    width: 100%;
    height: auto; /* Mantiene la proporción del gráfico */
}

.text-block {
    width: 100%;
    max-width: 800px; /* Ajusta el tamaño máximo del recuadro de texto */
    margin: 0 auto; /* Centra el recuadro de texto en la página */
    border: 1px solid gray; /* Borde gris */
    padding: 10px;
    box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
    background-color: #f9f9f9;
}

/* Estilos para pantallas más pequeñas (móviles) */
@media (max-width: 768px) {
    .chart-wrapper {
        gap: 15px; /* Reduce el espacio entre los elementos en móviles */
    }
}
</style>
{% endblock %}


{% block title %}
SmartBusinessMedia-Ventas
{% endblock %}

{% block branding %}
<img src="{% static 'img/m2.png' %}" height="20px" alt="Logo">
{% endblock %}

{% block breadcrumbs %}

  <div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">Home</a> &rsaquo;
    <a href="{% url 'admin:businessmodel_venta_changelist' %}">Orders</a> &rsaquo;
    <a href="{% url 'admin:businessmodel_venta_change' venta.id %}">Order {{ venta.id }}</a> &rsaquo; Detail
  </div>
{% endblock %}

{% block content %}

<div id="content-main"></div>
  <div class="notifications-container">
    <div class="notifications-content">
      <span>Ingresos Totales:  | </span>
      <span>Ventas Netas: | </span>
      <span>Costo de Ventas: | </span>
      <span>Margen Bruto: | </span>
      <span>Ganancia Bruta: | </span>
      <span>Gastos Operativos: | </span>
      <span>Ganancia Operativa: | </span>
      <span>Margen Operativo: | </span>
      <span>Ganancia Neta: | </span>
      <span>Rendimiento de Ventas: | </span>
      <span>Índice de Rotación de Inventario: | </span>
      <span>Días de Inventario: | </span>
      <span>Tasa de Crecimiento de Ventas: | </span>
      <span>Ventas por Empleado: | </span>
      <span>Ciclo de Conversión de Efectivo: | </span>
      <span>Tasa de Descuento en Ventas: | </span>
      <span>Valor del Cliente en el Tiempo: | </span>
      <span>Costo de Adquisición de Clientes: | </span>
      <!-- Agrega más notificaciones según sea necesario -->
    </div>
  </div>
 

    
    <!-- Estructura de Pestañas -->
    <div class="tabs">
      <button class="tab-button" onclick="openTab(event, 'estadisticas')">Analíticas de Ventas</button>
      <button class="tab-button" onclick="openTab(event, 'detalles')">Detalles del Pedido</button>
      <button class="tab-button" onclick="openTab(event, 'grafico')">Gráfico</button>
      <button class="tab-button" onclick="openTab(event, 'informacion')">Información de Venta</button>
      <!-- Nueva pestaña de Parámetros Financieros de Venta -->
      <button class="tab-button" onclick="openTab(event, 'financieros')">Parámetros Financieros</button>
    </div>

    
    <!-- Contenido de las Pestañas -->
    <div id="estadisticas" class="tab-content">      
      <div class="module">
      <div class="chart-wrapper">
          <!-- Formulario para seleccionar el período -->
          <form method="GET" action="{% url 'ventas_grafico' %}" class="filter-form">
              <div class="form-row">
                  <div class="form-group">
                      <label for="{{ form.periodo.id_for_label }}">{{ form.periodo.label }}</label>
                      {{ form.periodo }}
                  </div>
  
              </div>
              <button type="submit">Analizar</button>
          </form>
  
          <!-- Imagen del gráfico -->
          <div class="chart-container">
              <img id="chart" src="{% url 'ventas_grafico' %}?periodo={{ form.periodo.value }}" alt="Ventas Gráfico">
          </div>
  
          <!-- Recuadro de texto -->
          <div class="text-block">
              <h2>Descripción</h2>
              <p>Aquí puedes añadir un texto descriptivo sobre el gráfico. Proporciona detalles sobre los datos que se presentan, como la interpretación de las tendencias, las principales conclusiones, o cualquier otro comentario relevante.</p>
              <p>Este texto puede ayudar a los usuarios a entender mejor el gráfico y cómo los datos se relacionan con el período seleccionado y los productos filtrados.</p>

              <table id="result_list" class="table table-striped">
                <thead>
                    <tr>
                        <th>Parámetros de venta</th>
                        <th>Montos</th>
                        <th>Cantidad</th>
                        <!-- Agrega más encabezados si es necesario -->
                    </tr>
                </thead>
                <tbody>
                    <!-- Filas de datos -->
                    <tr class="row{% cycle '1' '2' %}">
                        <td>Ingresos Totales</td>
                        <td>${{ total_ingreso }}</td>
                        <td>{{ total_ingreso_cantidad }}</td>
                    </tr>
            
                    <!-- Fila de totales u otros datos -->
                    <tr class="total">
                        <td colspan="2">Ventas Netas</td>
                        <td>${{ ventas_netas }}</td>
                    </tr>
            
                    <tr class="row{% cycle '1' '2' %}">
                        <td>Costo de Ventas</td>
                        <td>${{ costo_unitario_total }}</td>
                        <td></td>
                    </tr>
            
                    <tr class="row{% cycle '1' '2' %}">
                        <td>Margen Bruto</td>
                        <td>${{ margen_bruto }}</td>
                        <td></td>
                    </tr>
            
                    <tr class="row{% cycle '1' '2' %}">
                        <td>Ganancia Bruta</td>
                        <td>${{ ganancia_bruta }}</td>
                        <td></td>
                    </tr>
            
                    <tr class="row{% cycle '1' '2' %}">
                        <td>Gastos Operativos</td>
                        <td>${{ gastos_operativos }}</td>
                        <td></td>
                    </tr>
            
                    <tr class="row{% cycle '1' '2' %}">
                        <td>Ganancia Operativa</td>
                        <td>${{ ganancia_operativa }}</td>
                        <td></td>
                    </tr>
            
                    <tr class="row{% cycle '1' '2' %}">
                        <td>Margen Operativo</td>
                        <td>{{ margen_operativo }}%</td>
                        <td></td>
                    </tr>
            
                    <tr class="row{% cycle '1' '2' %}">
                        <td>Ganancia Neta</td>
                        <td>${{ ganancia_neta }}</td>
                        <td></td>
                    </tr>
            
                    <tr class="row{% cycle '1' '2' %}">
                        <td>Rendimiento de Ventas</td>
                        <td>{{ rendimiento_ventas }}%</td>
                        <td></td>
                    </tr>
            
                    <tr class="row{% cycle '1' '2' %}">
                        <td>Índice de Rotación de Inventario</td>
                        <td>{{ indice_rotacion_inventario }}</td>
                        <td></td>
                    </tr>
            
                    <tr class="row{% cycle '1' '2' %}">
                        <td>Días de Inventario</td>
                        <td>{{ dias_inventario }}</td>
                        <td></td>
                    </tr>
            
                    <tr class="row{% cycle '1' '2' %}">
                        <td>Tasa de Crecimiento de Ventas</td>
                        <td>{{ tasa_crecimiento_ventas }}%</td>
                        <td></td>
                    </tr>
            
                    <tr class="row{% cycle '1' '2' %}">
                        <td>Ventas por Empleado</td>
                        <td>${{ ventas_por_empleado }}</td>
                        <td></td>
                    </tr>
            
                    <tr class="row{% cycle '1' '2' %}">
                        <td>Ciclo de Conversión de Efectivo</td>
                        <td>{{ ciclo_conversion_efectivo }}</td>
                        <td></td>
                    </tr>
            
                    <tr class="row{% cycle '1' '2' %}">
                        <td>Tasa de Descuento en Ventas</td>
                        <td>{{ tasa_descuento_ventas }}%</td>
                        <td></td>
                    </tr>
            
                    <tr class="row{% cycle '1' '2' %}">
                        <td>Valor del Cliente en el Tiempo</td>
                        <td>${{ valor_cliente_tiempo }}</td>
                        <td></td>
                    </tr>
            
                    <tr class="row{% cycle '1' '2' %}">
                        <td>Costo de Adquisición de Clientes</td>
                        <td>${{ costo_adquisicion_clientes }}</td>
                        <td></td>
                    </tr>
                    <tr class="row{% cycle '1' '2' %}">
                      <td>desviacion_estandar</td>
                      <td>${{desviacion_estandar }}</td>
                      <td></td>
                  </tr>

                </tbody>
            </table>
            
          </div>
      </div>
    </div>
  </div>
  
  
  

    
  <div id="detalles" class="tab-content">
    <h4>Order Details</h4>
    {% if venta_info %}
    <table id="result_list" class="table table-striped">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Monto</th>
          <th>Cantidad</th>
          <th>Producto</th>
          <th>Costo Unitario</th>
          <th>Descuentos</th>
          <th>Devoluciones</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>{{ venta_info.fecha }}</td>
          <td>{{ venta_info.monto }}</td>
          <td>{{ venta_info.cantidad }}</td>
          <td>{{ venta_info.producto }}</td>
          <td>{{ venta_info.costo_unitario }}</td>
          <td>{{ venta_info.descuentos }}</td>
          <td>{{ venta_info.devoluciones }}</td>
        </tr>
      </tbody>
    </table>
    {% else %}
    <p>No se encontraron datos de ventas.</p>
    {% endif %}
</div>

    <div id="grafico" class="tab-content">
      <h4>Gráfico Adicional</h4>

    
      <div class="module">
        <img id="ventas-grafico-2" src="{% url 'ventas_grafico' %}?v={{ timestamp }}" alt="Ventas Gráfico" class="responsive-img">
      </div>
    </div>

    <div id="informacion" class="tab-content">
      <h4>Información de Venta</h4>
      <table class="info-table">
        <tbody>
          <tr>
            <th class="info-name">Nombre</th>
            <td class="info-value">{{ order.customer_name }}</td>
          </tr>
          <tr>
            <th class="info-name">Apellido</th>
            <td class="info-value">{{ order.customer_surname }}</td>
          </tr>
          <tr>
            <th class="info-name">Producto</th>
            <td class="info-value">{{ order.product_name }}</td>
          </tr>
          <tr>
            <th class="info-name">Monto</th>
            <td class="info-value">${{ order.amount }}</td>
          </tr>
          <tr>
            <th class="info-name">Fecha</th>
            <td class="info-value">{{ order.date|date:"d/m/Y" }}</td>
          </tr>
          <tr>
            <th class="info-name">Hora</th>
            <td class="info-value">{{ order.time|date:"H:i" }}</td>
          </tr>
          <tr>
            <th class="info-name">Número de Orden</th>
            <td class="info-value">{{ order.order_number }}</td>
          </tr>
          <tr>
            <th class="info-name">Método de Pago</th>
            <td class="info-value">{{ order.payment_method }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Contenido para la nueva pestaña de Parámetros Financieros -->
    <div id="financieros" class="tab-content">
      <h4>Parámetros Financieros de Venta</h4>
      <table class="info-table">
        <tbody>
          <tr>
            <th class="info-name">Ingresos Totales</th>
            <td class="info-value">${{ ingresos_totales }}</td>
            <td class="info-description">Suma total de todos los ingresos generados por las ventas.</td>
          </tr>
          <tr>
            <th class="info-name">Ventas Netas</th>
            <td class="info-value">${{ ventas_netas }}</td>
            <td class="info-description">Ingresos totales menos devoluciones, descuentos y rebajas.</td>
          </tr>
          <tr>
            <th class="info-name">Costo de Ventas</th>
            <td class="info-value">${{ costo_ventas }}</td>
            <td class="info-description">Gastos asociados directamente con la producción de bienes vendidos.</td>
          </tr>
          <tr>
            <th class="info-name">Margen Bruto</th>
            <td class="info-value">${{ margen_bruto }}</td>
            <td class="info-description">Ingresos netos menos el costo de ventas.</td>
          </tr>
          <tr>
            <th class="info-name">Ganancia Bruta</th>
            <td class="info-value">${{ ganancia_bruta }}</td>
            <td class="info-description">Ingresos totales menos el costo de ventas.</td>
          </tr>
          <tr>
            <th class="info-name">Gastos Operativos</th>
            <td class="info-value">${{ gastos_operativos }}</td>
            <td class="info-description">Costos necesarios para mantener las operaciones diarias del negocio.</td>
          </tr>
          <tr>
            <th class="info-name">Ganancia Operativa</th>
            <td class="info-value">${{ ganancia_operativa }}</td>
            <td class="info-description">Ganancia generada a partir de las operaciones principales del negocio.</td>
          </tr>
          <tr>
            <th class="info-name">Margen Operativo</th>
            <td class="info-value">${{ margen_operativo }}</td>
            <td class="info-description">Porcentaje de ingresos que queda después de deducir los gastos operativos.</td>
          </tr>
          <tr>
            <th class="info-name">Ganancia Neta</th>
            <td class="info-value">${{ ganancia_neta }}</td>
            <td class="info-description">Beneficio total después de deducir todos los gastos, impuestos e intereses.</td>
          </tr>
          <tr>
            <th class="info-name">Rendimiento de Ventas</th>
            <td class="info-value">${{ rendimiento_ventas }}</td>
            <td class="info-description">Eficiencia de la empresa en generar beneficios a partir de las ventas.</td>
          </tr>
          <tr>
            <th class="info-name">Índice de Rotación de Inventario</th>
            <td class="info-value">{{ indice_rotacion_inventario }}</td>
            <td class="info-description">Frecuencia con la que el inventario se vende y se reemplaza en un período determinado.</td>
          </tr>
          <tr>
            <th class="info-name">Días de Inventario</th>
            <td class="info-value">{{ dias_inventario }}</td>
            <td class="info-description">Número promedio de días que un artículo permanece en inventario antes de ser vendido.</td>
          </tr>
          <tr>
            <th class="info-name">Tasa de Crecimiento de Ventas</th>
            <td class="info-value">{{ tasa_crecimiento_ventas }}</td>
            <td class="info-description">Porcentaje de aumento en las ventas durante un período específico.</td>
          </tr>
          <tr>
            <th class="info-name">Ventas por Empleado</th>
            <td class="info-value">${{ ventas_por_empleado }}</td>
            <td class="info-description">Promedio de ventas generadas por cada empleado en un período determinado.</td>
          </tr>
          <tr>
            <th class="info-name">Ciclo de Conversión de Efectivo</th>
            <td class="info-value">{{ ciclo_conversion_efectivo }}</td>
            <td class="info-description">Tiempo que tarda una empresa en convertir sus inversiones en inventario y otros recursos en efectivo a partir de ventas.</td>
          </tr>
          <tr>
            <th class="info-name">Tasa de Descuento en Ventas</th>
            <td class="info-value">{{ tasa_descuento_ventas }}</td>
            <td class="info-description">Porcentaje promedio de descuento aplicado a las ventas.</td>
          </tr>
          <tr>
            <th class="info-name">Valor del Cliente en el Tiempo</th>
            <td class="info-value">${{ valor_cliente_tiempo }}</td>
            <td class="info-description">Valor total que se espera que un cliente genere durante toda su relación con la empresa.</td>
          </tr>
          <tr>
            <th class="info-name">Costo de Adquisición de Clientes</th>
            <td class="info-value">${{ costo_adquisicion_clientes }}</td>
            <td class="info-description">Costo promedio para adquirir un nuevo cliente.</td>
          </tr>
        </tbody>
      </table>
    </div>

  </div>

  <script>
    // Función para abrir una pestaña
    function openTab(evt, tabId) {
      var i, tabContent, tabButtons;

      // Ocultar todos los contenidos de las pestañas
      tabContent = document.getElementsByClassName("tab-content");
      for (i = 0; i < tabContent.length; i++) {
        tabContent[i].style.display = "none";
      }

      // Desactivar todos los botones de las pestañas
      tabButtons = document.getElementsByClassName("tab-button");
      for (i = 0; i < tabButtons.length; i++) {
        tabButtons[i].className = tabButtons[i].className.replace(" active", "");
      }

      // Mostrar el contenido de la pestaña seleccionada y activar el botón
      document.getElementById(tabId).style.display = "block";
      evt.currentTarget.className += " active";
    }

    // Función para actualizar el gráfico
    function updateGrafico() {
      var timestamp = new Date().getTime();
      document.getElementById('ventas-grafico').src = "{% url 'ventas_grafico' %}?v=" + timestamp;
      document.getElementById('ventas-grafico-2').src = "{% url 'ventas_grafico' %}?v=" + timestamp;
    }

    // Actualizar el gráfico cada 5 minutos
    setInterval(updateGrafico, 300000); // 300000 ms = 5 minutos

    // Actualizar el gráfico al cargar la página
    document.addEventListener('DOMContentLoaded', updateGrafico);

    // Abrir la primera pestaña por defecto
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelector(".tab-button").click();
    });


    document.querySelector('form').addEventListener('submit', function(event) {
            event.preventDefault();
            const periodo = document.querySelector('select[name="periodo"]').value;
            const img = document.getElementById('chart');
            img.src = `{% url 'ventas_grafico' %}?periodo=${periodo}&t=${new Date().getTime()}`;
        });

  </script>
{% endblock %}
